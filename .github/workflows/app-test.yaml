name: App Test

on:
    workflow_dispatch:
    pull_request:
        branches:
            - main
        paths:
            - keycloak/libs/**/src/**
            - keycloak/**/package.json
            - keycloak/**/package-lock.json
            - keycloak/src/**
            - keycloak/**/build.gradle.kts
            - keycloak/**/settings.gradle.kts
            - keycloak/gradle/**

concurrency:
    group: app-test-${{ github.ref }}
    cancel-in-progress: true

permissions:
    contents: read
    actions: read
    checks: write

jobs:
    playwright-version:
        name: Read Playwright version
        uses: ./.github/workflows/.extract-version.yaml
        with:
            libs_versions_path: ./keycloak/gradle/libs.versions.toml
            lib_name: "playwright"
        secrets: inherit

    check-formatting:
        name: Check code formatting
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout code
                uses: actions/checkout@v6

            -   name: Setup Java
                uses: actions/setup-java@v5
                with:
                    distribution: temurin
                    java-version: 21

            -   name: Setup Gradle
                uses: gradle/actions/setup-gradle@v5

            -   name: Run ktlint Check
                working-directory: keycloak
                run: ./gradlew ktlintCheck --stacktrace --configuration-cache

    unit-tests:
        name: Run Unit Tests
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: keycloak
        steps:
            -   name: Checkout code
                uses: actions/checkout@v6

            -   name: Setup Java
                uses: actions/setup-java@v5
                with:
                    distribution: temurin
                    java-version: 21

            -   name: Setup Gradle
                uses: gradle/actions/setup-gradle@v5

            -   name: Run Unit Tests
                run: ./gradlew test --stacktrace --configuration-cache

            -   name: Generate Code Coverage Report
                run: ./gradlew koverXmlReport --stacktrace

            -   name: Code Coverage Report
                id: jacoco
                uses: madrapps/jacoco-report@v1.7.2
                with:
                    paths: |
                        keycloak/libs/**/build/reports/kover/*.xml
                    token: ${{ secrets.GITHUB_TOKEN }}
                    title: Code Coverage Report
                    comment-type: "summary"
                    min-coverage-overall: 40
                    min-coverage-changed-files: 60

            -   name: Unit Test Reports
                uses: dorny/test-reporter@v2.5.0
                if: always()
                with:
                    name: Unit Test Reports
                    path: "keycloak/libs/**/build/test-results/test/*.xml"
                    reporter: java-junit

    integration-tests:
        name: Run Integration Tests
        runs-on: ubuntu-latest-8-cores
        defaults:
            run:
                working-directory: keycloak
        steps:
            -   name: Checkout code
                uses: actions/checkout@v6

            -   name: Setup Java
                uses: actions/setup-java@v5
                with:
                    distribution: temurin
                    java-version: 21

            -   name: Setup Gradle
                uses: gradle/actions/setup-gradle@v5

            -   name: Run Integration Tests
                run: ./gradlew integrationTest --stacktrace --configuration-cache

            -   name: Generate Code Coverage Report
                run: ./gradlew koverIntegrationXmlReport --stacktrace

            -   name: Code Coverage Report
                id: jacoco
                uses: madrapps/jacoco-report@v1.7.2
                with:
                    paths: |
                        keycloak/build/reports/kover/*.xml
                    token: ${{ secrets.GITHUB_TOKEN }}
                    title: Code Coverage Report
                    comment-type: "summary"
                    min-coverage-overall: 40
                    min-coverage-changed-files: 60

            -   name: Integration Test Reports
                uses: dorny/test-reporter@v2.5.0
                if: always()
                with:
                    name: Integration Test Reports
                    path: "keycloak/build/test-results/integrationTest/*.xml"
                    reporter: java-junit

    system-tests:
        name: Run System Tests
        runs-on: ubuntu-latest-8-cores
        needs:
            - playwright-version
        defaults:
            run:
                working-directory: keycloak
        steps:
            -   name: Checkout code
                uses: actions/checkout@v6

            -   name: Setup Java
                uses: actions/setup-java@v5
                with:
                    distribution: temurin
                    java-version: 21

            -   name: Setup Gradle
                uses: gradle/actions/setup-gradle@v5

            -   name: Install Playwright OS deps
                run: npx -y playwright@${{ needs.playwright-version.outputs.version }} install-deps

            -   name: Run System Tests
                run: ./gradlew systemTest --stacktrace --configuration-cache

            -   name: System Test Reports
                uses: dorny/test-reporter@v2.5.0
                if: always()
                with:
                    name: System Test Reports
                    path: "keycloak/build/test-results/systemTest/*.xml"
                    reporter: java-junit

            -   name: Upload Playwright artifacts
                uses: actions/upload-artifact@v6
                if: always()
                with:
                    name: playwright-artifacts
                    path: "keycloak/artifacts/playwright/**"
                    if-no-files-found: ignore
                    retention-days: 1
